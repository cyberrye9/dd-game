<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dungeons and Deliberations ‚Äî Can you sway your fellow jurors?</title>
  <style>
    :root{ --bg:#0e0f13; --panel:#151823; --muted:#23283a; --accent:#7aa2f7; --good:#2ecc71; --bad:#e74c3c; --text:#e7e9ee; --sub:#a9b1c6; --bubble-juror:#1d2333; --bubble-user:#0f1b2d; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(140deg,#0c0d12 0%,#121622 40%,#0c0d12 100%);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(10,12,18,.7);backdrop-filter: blur(6px);position:sticky;top:0;z-index:10;border-bottom:1px solid #1c2233}
    header h1{margin:0;font-size:18px;font-weight:700;display:flex;gap:6px;align-items:baseline}
    header h1 .tagline{font-weight:500;font-size:12px;color:var(--sub)}
    .wrap{display:grid;grid-template-columns:320px 1fr;gap:14px;max-width:1200px;margin:18px auto;padding:0 14px}

    /* Sidebar */
    .side{background:var(--panel);border:1px solid #1c2233;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:70vh}
    .side .tabs{display:flex;border-bottom:1px solid #22283a}
    .side .tabs button{flex:1;padding:10px 8px;background:transparent;color:var(--sub);border:0;border-right:1px solid #22283a;cursor:pointer}
    .side .tabs button.active{color:var(--text);background:#1a1f2f}
    .side .pane{display:none;padding:10px}
    .side .pane.active{display:block}
    .searchbar{display:flex;gap:8px}
    .searchbar input{flex:1;background:#0e1320;color:var(--text);border:1px solid #263149;border-radius:10px;padding:10px}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #303a57;background:#0e1320;color:#a9b1c6;cursor:pointer}
    .chip.active{background:#1a2542;color:#cbd6ff;border-color:#40508a}
    .evidence-list{margin-top:6px;display:grid;gap:8px;max-height:62vh;overflow:auto;padding-right:4px}
    .ev{border:1px solid #263149;background:#0f1526;border-radius:12px;padding:10px}
    .ev h4{margin:0 0 6px 0;font-size:14px}
    .ev .meta{font-size:12px;color:var(--sub);display:flex;gap:8px;flex-wrap:wrap}
    .ev .rate{margin-top:6px;font-size:12px}
    .btn-add{margin-top:8px;background:#0e1c36;color:#cbd6ff;border:1px solid #2d3c68;border-radius:10px;padding:6px 10px;cursor:pointer}

    /* Main */
    .main{display:flex;flex-direction:column;gap:12px}
    .status{display:grid;grid-template-columns:1fr auto;gap:10px}
    .juror-card{border:1px solid #1f2740;background:#131a2c;border-radius:14px;padding:10px;display:grid;grid-template-columns:60px 1fr;gap:10px}
    .avatar{width:60px;height:60px;border-radius:10px;background:linear-gradient(145deg,#192144,#0d1430);display:grid;place-items:center;font-weight:800;color:#a8b7ff}
    .juror-card h2{margin:0 0 2px 0;font-size:16px}
    .juror-card .small{color:var(--sub);font-size:12px}
    .meter{margin-top:8px;height:10px;border-radius:999px;background:#0e1424;border:1px solid #253056;overflow:hidden}
    .meter > span{display:block;height:100%;background:linear-gradient(90deg,#9fd7b7,#2ecc71);width:0%}
    .progress{display:flex;gap:6px;flex-wrap:wrap;align-content:flex-start}
    .dot{width:16px;height:16px;border-radius:50%;border:1px solid #2c375e;background:#0c1222}
    .dot.win{background:linear-gradient(180deg,#2ecc71,#19a15a)}
    .dot.cur{box-shadow:0 0 0 2px #2c375e inset,0 0 0 4px #10162a}

    .hud{display:flex;gap:12px;align-items:center}
    .badge{border:1px solid #2d3c68;background:#111a30;color:#cbd6ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .badge.bad{background:#2a1116;color:#ffd6d6;border-color:#5a2a2f}

    .chat{border:1px solid #1f2740;background:#111725;border-radius:14px;padding:12px;min-height:46vh;max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:10px}
    .msg{max-width:80%;padding:10px 12px;border-radius:12px}
    .msg.juror{align-self:flex-start;background:var(--bubble-juror);border:1px solid #263149}
    .msg.user{align-self:flex-end;background:var(--bubble-user);border:1px solid #1d2a4a}
    .msg .who{font-size:12px;color:#9fb0e0;margin-bottom:4px}

    .composer{display:grid;grid-template-columns:1fr auto;gap:8px}
.composer textarea{color:var(--text);border:1px solid #263149;border-radius:12px;padding:10px}
    .composer .actions{display:flex;gap:8px;flex-direction:column}
    .btn{background:#1a2542;color:#cbd6ff;border:1px solid #2d3c68;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn.secondary{background:#131a2c;color:#c2c8dc}
    .sel-ev{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #3b4773;background:#0d1426;color:#b8c3ee}

    .foot{display:flex;gap:8px;justify-content:flex-end}

    /* Timeline */
    .timeline{display:grid;gap:8px;max-height:62vh;overflow:auto}
    .titem{border:1px solid #263149;background:#0f1526;border-radius:12px;padding:10px}
    .titem .tdate{font-size:12px;color:#9fb0e0;margin-bottom:4px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:100}
    .modal{background:#121725;border:1px solid #2a355a;border-radius:16px;padding:20px;max-width:720px;color:#e8ecff;text-align:left}
    .modal h3{margin:0 0 10px 0}
    .modal p{color:#b9c1e0}

    @media (max-width: 900px){ .wrap{grid-template-columns:1fr} .side{order:2} .main{order:1} .composer{grid-template-columns:1fr} }

<style>
  /* Intro overlay layout */
  #intro-overlay {
    position: fixed; inset: 0; display: grid; place-items: center;
    background:#0b0e14; color:#e6e9ef; z-index: 9999;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    text-align: center; padding: 24px;
  }
  #intro-overlay h1 { font-size: clamp(28px, 5vw, 48px); margin: 0 0 12px; }
  #intro-overlay h2 { font-size: clamp(16px, 3vw, 24px); margin: 0; opacity: 0.85; }
  
  /* Caret */
  #tw-caret {
    display:inline-block; width: .6ch; height: 1.25em; margin-left: 4px;
    vertical-align: -2px; background: currentColor; opacity: 0; 
    animation: caret-blink .9s step-end infinite;
  }
  @keyframes caret-blink { 50% { opacity: .9 } }

  /* Smooth fade‚Äëout of the overlay when done */
  .intro-hide { animation: introFade 500ms ease forwards }
  @keyframes introFade { to { opacity: 0; visibility: hidden } }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #tw-caret { animation: none; opacity: 0 }
  }
</style>

  </style>
<style>
  /* Fullscreen overlay */
  #typing-intro {
    position: fixed; inset: 0;
    background: #000; color: #f5f5f5;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
    font-family: "Courier New", monospace;
    z-index: 9999;
    text-align: center;
  }

 /* Title (Mario red with bold arcade shadow) */
#typing-intro h1 {
  font-family: "Courier New", monospace;
  font-size: clamp(28px, 5vw, 48px);
  font-weight: bold;
  color: #ff3b30; /* Mario red */
  text-shadow: 
    2px 2px 0 #000,
    4px 4px 0 #ffd400; /* yellow arcade-style offset */
  margin: 0 0 14px;
}

/* Subtitle (coin gold with shadow) */
#typing-intro h2 {
  font-family: "Courier New", monospace;
  font-size: clamp(14px, 3vw, 22px);
  font-weight: bold;
  color: #ffd400; /* coin gold */
  text-shadow: 
    2px 2px 0 #000,
    3px 3px 0 #c99f00;
  margin: 0;
}

  #intro-caret {
    Display:none;
    width: .6ch; height: 1.2em;
    background: #f5f5f5;
    margin-left: 3px;
    animation: blink 0.8s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0 } }

  /* Fade out animation for overlay */
  .fade-out { animation: fadeOut 1s forwards; }
  @keyframes fadeOut { to { opacity:0; visibility:hidden } }
/* NEW: Video animation container */
#transition-animation {
  margin-top: 40px;
  opacity: 0;
  transition: opacity 0.5s ease-in-out;
}

.show-animation {
  opacity: 1 !important;
}

#runner-video {
  width: 300px;
  height: auto;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(255, 212, 0, 0.5);
}

.entering-text {
  margin-top: 20px; 
  font-size: 18px; 
  color: #ffd400;
  text-shadow: 2px 2px 0 #000;
}
</style>

</head>
<body>
<!-- Fullscreen Intro Typing Screen -->
<div id="typing-intro">
  <div class="typing-wrap">
    <h1 id="intro-title"></h1>
    <h2 id="intro-sub"></h2>
    <span id="intro-caret"></span>
<!-- NEW: Video animation that plays after typing -->
<div id="transition-animation">
 <video
  id="runner-video"
  autoplay
  muted
  playsinline
  preload="auto"
  style="width:100%;height:100%;object-fit:cover;">
  <source src="runneranimation.mp4" type="video/mp4">
</video>
<script>
  const v = document.getElementById('runner-video');
  v.play().catch(() => {
    // force play after first interaction if browser blocks it
    window.addEventListener('click', () => v.play(), { once: true });
  });
</script>

  <div class="entering-text">
    Entering the courtroom...
  </div>
</div>
  </div>
</div>

<!-- Intro Overlay -->
<div id="intro-overlay" aria-live="polite">
  <h1 id="tw-title" class="type"></h1>
  <h2 id="tw-sub" class="type"></h2>
  <span id="tw-caret" aria-hidden="true"></span>
</div>

  <header>
    <h1>Dungeons and Deliberations <span class="tagline">‚Äî Can you sway your fellow jurors?</span></h1>
    <div class="foot">
      <button class="btn secondary" id="btn-reset">Reset</button>
      <button class="btn" id="btn-export">Export Save</button>
      <button class="btn" id="btn-import">Import Save</button>
    </div>
  </header>

  <div class="wrap">
    <aside class="side">
      <div class="tabs">
        <button class="active" data-tab="evtab">Evidence</button>
        <button data-tab="casetab">Case Breakdown</button>
      </div>
      <div class="pane active" id="evtab">
        <div class="searchbar">
          <input id="ev-search" placeholder="Search evidence (keywords)‚Ä¶" />
          <button class="btn" id="ev-clear">Clear</button>
        </div>
        <div class="filters">
          <span class="chip" data-filter="type:hard">Hard</span>
          <span class="chip" data-filter="type:circumstantial">Circumstantial</span>
          <span class="chip" data-filter="tag:forensic">Forensic</span>
          <span class="chip" data-filter="tag:behavioral">Behavioral</span>
          <span class="chip" data-filter="tag:computer">Computer</span>
          <span class="chip" data-filter="tag:timeline">Timeline</span>
          <span class="chip" data-filter="strength:4+">High strength</span>
        </div>
        <div class="evidence-list" id="evidence-list"></div>
      </div>
      <div class="pane" id="casetab">
        <div class="timeline" id="case-timeline"></div>
        <div style="border-top:1px solid #22283a;margin:10px 0 0 0;padding-top:8px">
          <h4 style="margin:0 0 6px 0">Case Facts (neutral)</h4>
          <div class="timeline" id="case-facts"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <section class="status">
        <div class="juror-card">
          <div class="avatar" id="juror-avatar">J1</div>
          <div>
            <h2 id="juror-name">Juror Name</h2>
            <div class="small" id="juror-desc"></div>
            <div class="meter" title="Persuasion"><span id="meter-bar"></span></div>
            <div class="small" id="juror-guidance"></div>
          </div>
        </div>
        <div class="hud">
         <div class="badge" id="turns-badge" title="Group tolerance for more debate">Patience: 6/6</div>
<div class="badge bad" id="strikes-badge" title="Credibility hits">Credibility: 0/3 strikes</div>

        </div>
        <div class="progress" id="progress"></div>
      </section>

      <section class="chat" id="chat"></section>

      <section class="composer">
        <div>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
            <label class="small" for="tactic" style="color:#a9b1c6">Tactic</label>
            <select id="tactic" class="btn" style="padding:6px 10px">
              <option value="logic">Logic Push</option>
              <option value="emotion">Emotional Appeal</option>
              <option value="authority">Authority & Procedure</option>
              <option value="narrative">Narrative Cohesion</option>
              <option value="socratic">Socratic Probe</option>
              <option value="chrono">Chronology Lock</option>
              <option value="occam">Occam‚Äôs Razor</option>
              <option value="moral">Moral Duty</option>
              <option value="forensic">Forensic Chain</option>
              <option value="pattern">Pattern Consistency</option>
              <option value="cred">Credibility Check</option>
              <option value="spiral">Narrative Spiral</option>
            </select>
            <span class="small" id="roll-hint" style="color:#9fb0e0">üé≤ d20 check applies on send</span>
          </div>
          <textarea id="input" placeholder="Argue guilt. Add evidence from the left."></textarea>
          <div class="sel-ev" id="selected-ev"></div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btn-clear-sel">Clear Evidence</button>
          <button class="btn" id="btn-send">Send</button>
        </div>
      </section>
    </main>
  </div>

  <!-- Intro Overlay -->
  <div class="overlay" id="intro" style="display:flex">
  <div class="modal">
  <h3>Welcome to Dungeons and Deliberations</h3>
  <p>You are serving on a high-profile jury.</strong>. You‚Äôre Juror #12, and your goal is to persuade the others toward a guilty verdict using evidence and tailored argument styles.</p>

  <h4>üéÆ Rules of Play (Game Mechanics)</h4>
  <ul style="margin:6px 0 0 18px;line-height:1.35">
    <li><strong>Patience:</strong> Jurors‚Äô openness shrinks if you stall or repeat yourself. Make moves that advance persuasion.</li>
    <li><strong>Strikes:</strong> Up to 3 credibility strikes for bad mismatches (defense-leaning or doubt-heavy). At 3 strikes, you lose.</li>
    <li><strong>Tactics & Evidence:</strong> Select a tactic and add relevant prosecution evidence. Different jurors value logic, emotion, authority, or narrative differently.</li>
  </ul>

  <h4>üßë‚Äç‚öñÔ∏è Juror Roleplay (How to Behave)</h4>
  <ul style="margin:6px 0 0 18px;line-height:1.35">
    <li>Argue like a peer, not a lawyer; respond to what that juror cares about.</li>
    <li>Read their replies‚Äîsubtle hints point to what will sway them.</li>
    <li>Keep the focus on <em>guilt</em>. Doubt-heavy framing will cost credibility.</li>
  </ul>

  <div style="display:flex;align-items:center;justify-content:flex-end;margin-top:14px">
    <button class="btn" id="btn-start">View Case Snapshot ‚Üí</button>
  </div>
</div>
</div>
<!-- Case Snapshot Overlay (appears after Intro) -->
<div class="overlay" id="case" style="display:none">
  <div class="modal">
    <h3>Case Snapshot ‚Äî <em>State of Florida v. Casey Anthony</em></h3>

    <ul style="margin:6px 0 0 18px;line-height:1.35">
      <li><strong>Date of Incident:</strong> June 16, 2008</li>
      <li><strong>Defendant:</strong> Casey Anthony</li>
      <li><strong>Charge:</strong> First-degree murder of Caylee Anthony</li>
      <li><strong>Key Evidence Categories:</strong>
        <ul>
          <li>Behavioral ‚Äî 31-day delay; false statements; party photos during the period</li>
          <li>Digital ‚Äî searches for ‚Äúchloroform,‚Äù ‚Äúfool-proof suffocation‚Äù; phone/cell-site activity</li>
          <li>Forensic ‚Äî duct tape associated with remains; trunk odor; chloroform indications (disputed)</li>
        </ul>
      </li>
      <li><strong>Your Task:</strong> Select relevant items and craft arguments that fit each juror‚Äôs values.</li>
    </ul>

    <div style="display:flex;justify-content:flex-end;margin-top:14px">
      <button class="btn" id="btn-case-continue">Read Opening Statements ‚Üí</button>
    </div>
  </div>
</div>
<div class="overlay" id="theories" style="display:none">
  <div class="modal modal--theories">
    <h3 class="theories__title">‚öñÔ∏è Opening Statements</h3>

   <div class="theories__card">
  <h4>Prosecution Theory</h4>
<p>
    Casey Anthony murdered her daughter, Caylee, and then carried on as if nothing had happened. 
    She used chloroform to sedate her, suffocated her with duct tape, and placed her body in the trunk 
    of her car before leaving her remains in a wooded area less than a mile from the family home.
  </p>
  <p>
    For the next thirty-one days, while Caylee was missing, Casey partied, shopped, and stayed with her boyfriend. 
    To disguise her child‚Äôs absence, she wove a web of lies ‚Äî inventing babysitters, fabricating jobs, and describing 
    daily routines that never existed.
  </p>
  <p>
    When Casey‚Äôs car was examined, both her father, a former police officer, and investigators reported the odor of human 
    decomposition coming from the trunk. Forensic testing also revealed chloroform residue and a strand of hair consistent 
    with Caylee inside.
  </p>
  <p>
    Her behavior, deception, and the forensic evidence all point to one conclusion: Casey Anthony murdered her daughter 
    to free herself from the responsibilities of motherhood.
  </p>
  <blockquote>
    <em>"Casey Anthony loved her life. And Caylee's life interrupted it."</em> ‚Äì Prosecutor Jeff Ashton
  </blockquote>
</div>

      <div class="theories__card">
       <h4>Defense Theory (context)</h4>
<p>
Caylee Anthony was never missing, and she was never murdered. On June 16, 2008, she drowned in the family swimming pool.
George Anthony, her grandfather and a former police officer, discovered her body and told Casey to cover it up. For the
next 31 days, Casey acted as though nothing happened ‚Äî not out of malice, but because she had learned from years of abuse
and dysfunction to hide pain and obey her father.
</p>
<p>
George Anthony sexually abused Casey from the time she was eight years old, teaching her to live a life of secrecy and
denial. Caylee‚Äôs death was a tragic accident twisted into a murder case. The state‚Äôs forensic evidence is unreliable,
their conclusions speculative, and their narrative an effort to make Casey a scapegoat for a family‚Äôs dysfunction.
</p>
<p>
No cause of death could be determined from Caylee‚Äôs remains. There were no witnesses placing Casey harming her child,
and the forensic results were open to multiple interpretations. To the defense, the prosecution‚Äôs case rested on speculation
and character attacks rather than proof beyond a reasonable doubt.
</p>
<blockquote>
<em>"This is not a murder case... and there is definitely no evidence of any child abuse."</em>‚Äì Jose Baez
</blockquote>
</div>
    </div>

    <div style="display:flex;justify-content:flex-end">
      <button class="btn" id="btn-theories-continue">Continue</button>
    </div>
  </div>
</div>


  <!-- Game Over Overlay -->
  <div class="overlay" id="overlay">
    <div class="modal" style="text-align:center">
      <h3 id="gameover-title">Game Over</h3>
      <p id="gameover-reason">The room‚Äôs patience ran out.</p>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button class="btn" id="btn-retry">Try Again</button>
        <button class="btn secondary" id="btn-quit">Reset</button>
      </div>
    </div>
  </div>

  <script>
  /*************************************************
   * Data ‚Äî Jurors, Evidence, Timeline
   *************************************************/
  const JURORS = [
    {id:1, short:"GenZ", name:"Gen Z TikTok Teen", age:18, archetype:"progressive, sarcastic, social-justice focused", style:"snarky", threshold:70, guiltBias:0.45, values:{emotion:0.6, logic:0.6, fairness:0.9, authority:0.3, doubt:0.8}},
    {id:2, short:"Retiree", name:"Conservative Retiree", age:65, archetype:"traditional values, skeptical", style:"plain", threshold:75, guiltBias:0.65, values:{emotion:0.3, logic:0.8, fairness:0.5, authority:0.7, doubt:0.5}},
    {id:3, short:"Mom", name:"Soccer Mom", age:42, archetype:"child‚Äëprotective, emotional", style:"empathetic", threshold:70, guiltBias:0.8, values:{emotion:0.9, logic:0.5, fairness:0.6, authority:0.5, doubt:0.4}},
    {id:4, short:"Tech", name:"Tech Professional", age:35, archetype:"analytical, data‚Äëdriven", style:"analytic", threshold:80, guiltBias:0.55, values:{emotion:0.2, logic:0.95, fairness:0.6, authority:0.6, doubt:0.7}},
    {id:5, short:"Blue", name:"Blue‚Äëcollar Worker", age:48, archetype:"practical, common sense", style:"blunt", threshold:72, guiltBias:0.6, values:{emotion:0.4, logic:0.7, fairness:0.7, authority:0.5, doubt:0.6}},
    {id:6, short:"Prof", name:"College Professor", age:55, archetype:"intellectual, debates everything", style:"debate", threshold:85, guiltBias:0.5, values:{emotion:0.3, logic:0.9, fairness:0.7, authority:0.5, doubt:0.8}},
    {id:7, short:"RN", name:"Healthcare Worker", age:29, archetype:"clinical, evidence‚Äëbased", style:"clinical", threshold:78, guiltBias:0.6, values:{emotion:0.3, logic:0.85, fairness:0.6, authority:0.7, doubt:0.7}},
    {id:8, short:"Vet", name:"Military Veteran", age:52, archetype:"black‚Äëand‚Äëwhite thinking", style:"direct", threshold:78, guiltBias:0.7, values:{emotion:0.3, logic:0.7, fairness:0.6, authority:0.9, doubt:0.5}},
    {id:9, short:"Artist", name:"Artist", age:31, archetype:"emotional, intuitive", style:"poetic", threshold:70, guiltBias:0.4, values:{emotion:0.95, logic:0.4, fairness:0.7, authority:0.3, doubt:0.6}},
    {id:10, short:"Exec", name:"Business Executive", age:44, archetype:"results‚Äëoriented, impatient", style:"sharp", threshold:75, guiltBias:0.65, values:{emotion:0.3, logic:0.75, fairness:0.5, authority:0.6, doubt:0.6}},
    {id:11, short:"Clergy", name:"Religious Leader", age:59, archetype:"moral compass, forgiveness‚Äëoriented", style:"pastoral", threshold:72, guiltBias:0.55, values:{emotion:0.7, logic:0.6, fairness:0.9, authority:0.5, doubt:0.7}},
  ];

  const JUROR_RULES = {
    Tech:{ req:{tags:{forensic:1, computer:1}}, tacticOneOf:['forensic','chrono'], prefer:'logic', traps:{emotionHeavy:true} },
    Prof:{ req:{combo:[['forensic',1],['behavioral',1]]}, tacticOneOf:['socratic','pattern'], prefer:'logic', traps:{fallacy:true} },
    Mom:{ req:{tags:{behavioral:2}}, tacticOneOf:['moral','spiral'], prefer:'emotion', traps:{defenseStrike:true} },
    RN:{ req:{tags:{forensic:2}}, tacticOneOf:['forensic'], prefer:'logic', traps:{emotionHeavy:true} },
    Vet:{ req:{eitherTag:['timeline','authority']}, tacticOneOf:['chrono','occam'], prefer:'authority', traps:{doubtHeavy:true} },
    Artist:{ req:{channel:'narrative'}, tacticOneOf:['spiral'], prefer:'narrative', traps:{clinicalHeavy:true} },
    Exec:{ req:{concise:true, tags:{behavioral:1,timeline:1}}, tacticOneOf:['chrono','pattern'], prefer:'authority', traps:{rambling:true} },
    Blue:{ req:{plain:true}, tacticOneOf:['occam','cred'], prefer:'blunt', traps:{jargon:true} },
    Retiree:{ req:{authorityOrBehavioral:true}, tacticOneOf:['occam','chrono'], prefer:'authority', traps:{speculative:true} },
    Clergy:{ req:{moral:true}, tacticOneOf:['moral'], prefer:'emotion', traps:{punitiveOnly:true} },
    GenZ:{ req:{tags:{computer:1}}, tacticOneOf:['cred','socratic','forensic'], prefer:'logic', traps:{authorityHeavy:true} }
  };

 const EVIDENCE = [
  {id:"ev1",  title:"31-day delay in reporting Caylee missing", type:"behavioral", class:"circumstantial", strength:4, side:"pros", tags:["behavioral","timeline"], notes:"Behavior after June 16, 2008; highly scrutinized."},
  {id:"ev2",  title:"Duct tape found with remains (Dec 2008)", type:"physical", class:"circumstantial", strength:3, side:"pros", tags:["forensic"], notes:"Presence and placement discussed at trial."},
  {id:"ev3",  title:"Hair with possible postmortem banding in car trunk (contested)", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic"], notes:"Banding interpretation disputed."},
  {id:"ev4",  title:"Air sample analysis suggesting chloroform (contested)", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic","chemical"], notes:"Methodology debated."},
  {id:"ev5",  title:"Computer searches incl. 'chloroform' & 'fool-proof suffocation' (attribution/time disputed)", type:"digital", class:"circumstantial", strength:3, side:"pros", tags:["computer","forensic"], notes:"Attribution/timing disputed."},
  {id:"ev6",  title:"Car trunk odor observations", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic"], notes:"Odor described by some as decomposition; alternatives discussed."},
  {id:"ev7",  title:"Remains found near home (Dec 2008)", type:"location", class:"circumstantial", strength:3, side:"pros", tags:["timeline","forensic"], notes:"Proximity considered."},
  {id:"ev8",  title:"Partying & photos during 31 days", type:"behavioral", class:"circumstantial", strength:3, side:"pros", tags:["behavioral"], notes:"Conduct vs expected behavior."},
  {id:"ev9",  title:"Family dynamics & conflicting statements", type:"context", class:"circumstantial", strength:2, side:"pros", tags:["behavioral","context"], notes:"Multiple false statements to investigators; credibility considerations."},
  {id:"ev10", title:"Cell-site and pings around key dates", type:"digital", class:"circumstantial", strength:3, side:"pros", tags:["computer","timeline"], notes:"Placement evidence; precision discussed."},
  {id:"ev11", title:"Duct tape adhesive transfer analysis (methodology debated)", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic"], notes:"Techniques/error rates at issue."},
  {id:"ev12", title:"Cadaver dog alerts (alerts disputed)", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic"], notes:"Handler reliability considered."},
  {id:"ev13", title:"Heart-shaped sticker residue association (disputed)", type:"forensic", class:"circumstantial", strength:2, side:"pros", tags:["forensic"], notes:"Reported outline on duct tape; similar stickers in home were discussed."},
  {id:"ev14", title:"Statements about nanny ('Zanny') later unsupported", type:"context", class:"circumstantial", strength:3, side:"pros", tags:["behavioral"], notes:"Credibility considerations."},
  {id:"ev15", title:"Timeline anchor ‚Äî June 16, 2008 last confirmed day with Caylee", type:"timeline", class:"hard", strength:5, side:"pros", tags:["timeline"], notes:"Baseline for events."},
];


  const TIMELINE = [
    {date:"2008-06-16", text:"Last confirmed day Caylee seen with mother (timeline anchor)."},
    {date:"2008-06-17..07-15", text:"Period where Caylee not reported missing; social activity/photos noted."},
    {date:"2008-07-15", text:"Caylee reported missing; investigation intensifies."},
    {date:"2008-12-11", text:"Remains found near family home area."},
    {date:"2011-05..07", text:"Trial proceedings; multiple forensic and behavioral points contested."},
  ];

  /*************************************************
   * Persistence & Difficulty
   *************************************************/
  const SAVE_KEY = 'jury_casey_v3_hard_12th';
  const DIFFICULTY = { name:'Hard', turnLimit:6, maxStrikes:3, meterDecay:2, mixedBiasTilt:-0.15, scale:4.2, thresholdBoost:10, strikePenalty:8, strikeThresholdBoostPer2:5 };
  const DEFAULT_STATE = () => ({ idx:0, persuaded:new Array(JURORS.length).fill(false), meter:0, chat:[{who:'juror', text: openingLine(JURORS[0])}], selected:[], turns:0, strikes:0, gameOver:false, reason:'', history: JURORS.map(()=>({forensic:0, behavioral:0, computer:0, timeline:0, pros:0, def:0})) });

  /*************************************************
   * Language & Effects
   *************************************************/
  const LEX = { 
    logic:["evidence","forensic","method","data","proof","chain of custody","error rate","peer review","control","timeline","metadata","cell","ping","video","photograph","sample","toxicology","analysis","causal","link","premise","inference"], 
    emotion:["feel","heart","child","mother","family","empathy","loss","tragedy","mercy","protect","safety"], 
    doubt:["uncertain","disputed","contested","alternative","could","might","maybe","inconsistent","no direct","lack of","doubt","speculative","unknown"], 
    authority:["law","rule","duty","procedure","burden","beyond reasonable doubt","standard","jury instruction","expert","precedent"], 
    fallacy:["obviously","everyone knows","always","never","must be","no way","strawman","ad hominem"] 
  };
  const TACTICS = { logic:{label:'Logic Push', w:{logic:1.3}}, emotion:{label:'Emotional Appeal', w:{emotion:1.35}}, authority:{label:'Authority & Procedure', w:{authority:1.3}}, narrative:{label:'Narrative Cohesion', w:{culpability:1.2, emotion:1.1}}, };
// Expanded tactics (keep difficulty; add more routes to win)
Object.assign(TACTICS, {
  socratic: { label: 'Socratic Probe', w:{ logic:1.25 }, extra:{ fallacyPenalty:0.5 } },
  chrono:   { label: 'Chronology Lock', w:{ authority:1.15, culpability:1.1 } },
  occam:    { label: "Occam's Razor", w:{ logic:1.2, culpability:1.15 }, extra:{ doubtPenalty:0.4 } },
  moral:    { label: 'Moral Duty', w:{ emotion:1.25, authority:1.05 } },
  forensic: { label: 'Forensic Chain', w:{ logic:1.25, authority:1.05 } },
  pattern:  { label: 'Pattern Consistency', w:{ culpability:1.2 }, extra:{ needsMultiTag:true } },
  cred:     { label: 'Credibility Check', w:{ culpability:1.15, logic:1.05 }, extra:{ needsContradiction:true } },
  spiral:   { label: 'Narrative Spiral', w:{ emotion:1.15, culpability:1.15 }, extra:{ antiClinical:true } },
});

  function classify(text){ const t=(text||'').toLowerCase(); const score={logic:0,emotion:0,doubt:0,authority:0,culpability:0,fallacy:0}; for(const k of Object.keys(LEX)) for(const w of LEX[k]) if(t.includes(w)) score[k]+=1; const CULP=["motive","opportunity","means","causal link","causation","admissions","consciousness of guilt","timeline fits","duct tape","chloroform","searches","fool‚Äëproof suffocation","31‚Äëday","delay reporting","nanny story","zanny","remains near home"]; for(const w of CULP) if(t.includes(w)) score.culpability+=1; const total=score.logic+score.emotion+score.doubt+score.authority+score.culpability+1; for(const k of ["logic","emotion","doubt","authority","culpability"]) score[k]=score[k]/total; return score; }
  function evidenceEffect(ev, juror){ const base=ev.strength; let m=1; if(ev.class==='hard') m+=0.6; if(ev.tags.includes('forensic')) m*=(0.8 + juror.values.logic*0.6); if(ev.tags.includes('behavioral')) m*=(0.9 + juror.values.emotion*0.5); if(ev.tags.includes('computer')) m*=(0.9 + juror.values.logic*0.5); if(ev.tags.includes('timeline')) m*=(0.8 + juror.values.doubt*0.4); if((ev.notes||'').toLowerCase().includes('disput')) m*=0.85; const bias=(juror.guiltBias ?? 0.5) + DIFFICULTY.mixedBiasTilt; let dir=0; if(ev.side==='pros') dir=1; else if(ev.side==='def') dir=-1; else dir=(bias-0.5)*2; return (base*m)*dir; }
  function messageEffect(msg, juror, tacticKey){ const c=classify(msg), v=juror.values; const tMod=TACTICS[tacticKey]?.w||{}; let lg=c.logic*(tMod.logic||1), em=c.emotion*(tMod.emotion||1), db=c.doubt, au=c.authority*(tMod.authority||1), cu=c.culpability*(tMod.culpability||1); let d=0; const PROSECUTION=true; d += lg * (0.7 + v.logic); d += au * (0.4 + v.authority); d += cu * (0.7 + (juror.guiltBias||0.5)); d += (db) * (PROSECUTION ? -1.2 : 1) * (0.6 + v.doubt); d += em * (0.35 + v.emotion); d -= c.fallacy * 1.5; return d * DIFFICULTY.scale; }
  function voiceLead(style, meter){ const levels = meter<25?0: meter<50?1: meter<75?2:3; const opts = { snarky:["Ok but‚Ä¶","Spicy take,","This isn‚Äôt TikTok‚Äî","I‚Äôm listening,"], plain:["Alright.","Hmm.","Understood.","Go on."], empathetic:["I feel the gravity here.","As a parent‚Äîthis hits.","That‚Äôs hard to hear.","It‚Äôs heavy."], analytic:["Let‚Äôs model this.","If we track the timestamps:","Mechanically‚Äî","Statistically‚Äî"], blunt:["Straight up:","Cut the fluff:","Bottom line:","Common sense‚Äî"], debate:["Counterpoint:","Steelman this:","Devil‚Äôs advocate:","Premise check:"], clinical:["Clinically:","Medically speaking:","From a lab view:","Symptomatically:"], direct:["By the book:","Orders style:","Discipline-wise:","Procedure:"], poetic:["Story-wise:","As a feeling:","Between the lines:","In the margins:"], sharp:["Time is money:","Cut to it:","ROI of certainty:","Net it out:"], pastoral:["Conscience says:","Mercy reminds:","We must be fair:","We‚Äôre accountable:"] }; return (opts[style]||opts.plain)[levels]+" "; }
  function voiceProbe(style){ const probes = { snarky:"What single fact ties her to the act‚Äîno vibes, just receipts?", plain:"Name the clearest inculpatory fact and how it links to her.", empathetic:"Which concrete action endangered the child and points to her?", analytic:"Give the strongest timestamped link: who/what/when proving guilt.", blunt:"What exact fact shows she did it?", debate:"State the premises that lead to guilt‚Äîno fallacies.", clinical:"What mechanism connects evidence to cause of death and her role?", direct:"Which rule or procedure shows culpability or concealment?", poetic:"Tell the coherent story the facts insist on‚Äîending with her responsible.", sharp:"Bottom line: which fact closes the loop to guilt?", pastoral:"What justifies a guilty verdict with moral certainty?" }; return probes[style]||probes.plain; }
  function openingLine(j){ const line = { snarky:"I‚Äôm juror Gen Z. Bring receipts that point to guilt.", plain:"Make the case for guilt with clear facts.", empathetic:"Protecting the child matters‚Äîshow why she‚Äôs responsible.", analytic:"Data or it didn‚Äôt happen‚Äîpresent your best proof of guilt.", blunt:"Spare the jargon. What shows she did it?", debate:"Lay out premises that conclude guilt.", clinical:"Walk me through mechanisms linking her to the outcome.", direct:"We follow rules and proof‚Äîargue the guilty case.", poetic:"Tell a coherent story where the facts end in culpability.", sharp:"Bottom line: prove it.", pastoral:"Justice requires certainty‚Äîshow why a guilty verdict is right." }; return line[j.style]||line.plain; }

  /*************************************************
   * State & Elements
   *************************************************/
  let state = null;
  const els = { avatar:document.getElementById('juror-avatar'), name:document.getElementById('juror-name'), desc:document.getElementById('juror-desc'), meter:document.getElementById('meter-bar'), guidance:document.getElementById('juror-guidance'), progress:document.getElementById('progress'), chat:document.getElementById('chat'), input:document.getElementById('input'), selectedEv:document.getElementById('selected-ev'), evList:document.getElementById('evidence-list'), evSearch:document.getElementById('ev-search'), evClear:document.getElementById('ev-clear'), btnSend:document.getElementById('btn-send'), btnClearSel:document.getElementById('btn-clear-sel'), btnReset:document.getElementById('btn-reset'), btnExport:document.getElementById('btn-export'), btnImport:document.getElementById('btn-import'), caseTimeline:document.getElementById('case-timeline'), caseFacts:document.getElementById('case-facts') };

function loadState(){
  const s = DEFAULT_STATE();
  if(!s.fails)      s.fails = new Array(JURORS.length).fill(0);
  if(!s.lastChange) s.lastChange = new Array(JURORS.length).fill(0);
  return s;
}
  function saveState(){ /* no-op for now; always fresh per load */ }

  function guidanceFor(j){ if(j.style==='analytic') return 'Use timestamps/methodology that link her to the act.'; if(j.style==='empathetic') return 'Center child safety + a coherent, culpability‚Äëfocused account.'; if(j.style==='snarky') return 'Receipts over vibes‚Äîfacts that close the loop to guilt.'; if(j.style==='clinical') return 'Explain mechanisms, handling, and how they implicate her.'; if(j.style==='direct') return 'Point to concealment or broken procedure indicating guilt.'; if(j.style==='debate') return 'Define premises that deduce guilt; avoid fallacies.'; if(j.style==='blunt') return 'Plain language‚Äîwhat best shows she did it?'; if(j.style==='poetic') return 'Coherent story that matches facts and ends in culpability.'; if(j.style==='sharp') return 'Lead with the decisive inculpatory point.'; if(j.style==='pastoral') return 'Justice with moral certainty; cite facts that warrant guilt.'; return 'Be clear, specific, and oriented to guilt.'; }

  function renderJuror(){ const j = JURORS[state.idx]; els.avatar.textContent='J'+j.id; els.name.textContent=`${j.name} (${j.age})`; els.desc.textContent = j.archetype + ` ‚Ä¢ ${DIFFICULTY.name}`; const boosted = Math.min(100, Math.max(0, state.meter - DIFFICULTY.thresholdBoost/2)); els.meter.style.width = Math.min(100, boosted)+'%'; els.guidance.textContent = guidanceFor(j); document.getElementById('turns-badge').textContent =
  `Patience: ${Math.max(0, DIFFICULTY.turnLimit - state.turns)}/${DIFFICULTY.turnLimit}`;
document.getElementById('strikes-badge').textContent =
  `Credibility: ${state.strikes}/${DIFFICULTY.maxStrikes} strikes`;
}
function renderProgress(){ els.progress.innerHTML=''; JURORS.forEach((j,i)=>{ const d=document.createElement('div'); d.className='dot'+(state.persuaded[i]?' win':'')+(state.idx===i?' cur':''); d.title=`${j.name}`; els.progress.appendChild(d); }); }
  function renderChat(){ els.chat.innerHTML=''; for(const m of state.chat){ const div=document.createElement('div'); div.className='msg '+(m.who==='juror'?'juror':'user'); const who=document.createElement('div'); who.className='who'; who.textContent = m.who==='juror' ? JURORS[state.idx].name : 'You'; const body=document.createElement('div'); body.textContent = m.text; div.appendChild(who); div.appendChild(body); els.chat.appendChild(div); } els.chat.scrollTop = els.chat.scrollHeight; }
  function renderSelected(){ els.selectedEv.innerHTML=''; for(const id of state.selected){ const ev=EVIDENCE.find(e=>e.id===id); if(!ev) continue; const t=document.createElement('span'); t.className='tag'; t.textContent=ev.title; t.title='Click to remove'; t.onclick=()=>{ state.selected = state.selected.filter(x=>x!==id); saveState(); renderSelected(); }; els.selectedEv.appendChild(t);} }
  let activeFilters=new Set();
  function renderEvidence(){ const q=(els.evSearch.value||'').toLowerCase().trim(); const list=EVIDENCE.filter(e=>{ const text=(e.title+' '+(e.notes||'')+' '+(e.tags||[]).join(' ')).toLowerCase(); if(q && !text.includes(q)) return false; for(const f of activeFilters){ const [k,v]=f.split(':'); if(k==='type' && e.class!==v) return false; if(k==='tag' && !(e.tags||[]).includes(v)) return false; if(k==='strength' && v==='4+' && !(e.strength>=4)) return false; } return true; }); els.evList.innerHTML=''; for(const e of list){ const div=document.createElement('div'); div.className='ev'; const h=document.createElement('h4'); h.textContent=e.title; div.appendChild(h); const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${e.type} ‚Ä¢ ${e.class} ‚Ä¢ Strength ${e.strength}/5 ‚Ä¢ ${e.side==='pros'?'Prosecution':e.side==='def'?'Defense':'Mixed'}`; div.appendChild(meta); const r=document.createElement('div'); r.className='rate'; r.textContent='Strategic weight: '+(e.side==='pros'?'Supports guilt':e.side==='def'?'Helps defense':'Depends on juror'); div.appendChild(r); if(e.notes){ const n=document.createElement('div'); n.className='rate'; n.style.color='#9fb0e0'; n.textContent=e.notes; div.appendChild(n);} const b=document.createElement('button'); b.className='btn-add'; b.textContent='Add to Argument'; b.onclick=()=>{ if(!state.selected.includes(e.id)){ state.selected.push(e.id); saveState(); renderSelected(); } }; div.appendChild(b); els.evList.appendChild(div);} }
  function renderTimeline(){
    els.caseTimeline.innerHTML='';
    for(const t of TIMELINE){
      const d=document.createElement('div');
      d.className='titem';
      const dt=document.createElement('div');
      dt.className='tdate';
      dt.textContent=t.date;
      d.appendChild(dt);
      d.appendChild(document.createTextNode(t.text));
      els.caseTimeline.appendChild(d);
    }
  }
  const FACTS = [
    {label:'Location', text:'Orlando, Florida; family home area relevant to discovery site.'},
    {label:'People', text:'Defendant is Caylee‚Äôs mother; grandparents involved in household.'},
    {label:'Reporting', text:'Caylee reported missing on July 15, 2008.'},
    {label:'Discovery', text:'Remains located in December 2008 near family area.'},
    {label:'Proceedings', text:'Trial held in 2011; multiple items were contested by experts.'}
  ];
  function renderFacts(){
    els.caseFacts.innerHTML='';
    for(const f of FACTS){
      const d=document.createElement('div');
      d.className='titem';
      const dt=document.createElement('div');
      dt.className='tdate';
      dt.textContent=f.label;
      d.appendChild(dt);
      d.appendChild(document.createTextNode(f.text));
      els.caseFacts.appendChild(d);
    }
  }
/****************************************************************
 * Hints (oblique, personality-based)
 ****************************************************************/
const HINTS = {
  GenZ: [
    "Spare the vibes. What would screenshot culture call a receipt?",
    "Two different lanes tell the same story‚Äîtry pairing them.",
    "If a story has a hole, point at the hole-maker, not the hole.",
  ],
  Retiree: [
    "Simple beats clever. Reduce to the fewest working parts.",
    "If duty was skipped, name the skipped step, then the consequence.",
    "The straightest path isn‚Äôt sentimental.",
  ],
  Mom: [
    "Talk about care, not code.",
    "Two concrete behaviors outweigh one theory.",
    "Protect the child first, then assign the why.",
  ],
  Tech: [
    "Timestamps before takes.",
    "Chain the method, not the mood.",
    "Two independent signals increase confidence.",
  ],
  Blue: [
    "Say it like you‚Äôre fixing a leak: where‚Äôs the crack?",
    "Plain words. One problem, one cause.",
    "If it sounds like a slogan, it probably is.",
  ],
  Prof: [
    "State premises. Show how they entail the claim.",
    "Varied sources, same conclusion. That‚Äôs the point.",
    "If you can‚Äôt formalize it, don‚Äôt sell it.",
  ],
  RN: [
    "Mechanism first, emotion later.",
    "If it wasn‚Äôt measured, it‚Äôs conjecture.",
    "Two clinicals beat one anecdote.",
  ],
  Vet: [
    "Clock and rule. Which were violated?",
    "Order of events matters more than adjectives.",
    "Certainty earns respect; hedging doesn‚Äôt.",
  ],
  Artist: [
    "Make the narrative lock‚Äîsetup, turn, inevitability.",
    "Choose images, not instruments.",
    "If the ending is true, the middle should foreshadow it.",
  ],
  Exec: [
    "Lead with the bottleneck.",
    "Two bullets: when and what changed.",
    "Concision is credibility.",
  ],
  Clergy: [
    "Name the duty owed, then the harm done.",
    "Mercy needs truth; supply the latter.",
    "Conscience follows facts.",
  ],
};

function getHint(key, tier=0){
  const arr = HINTS[key] || [];
  return arr[Math.min(tier, arr.length-1)] || "Refine your angle.";
}

function vagueReqHint(req){
  if(!req) return null;
  if (req.tags) {
    const keys = Object.keys(req.tags);
    if (keys.includes('forensic'))   return "Receipts aren‚Äôt lab-grade yet.";
    if (keys.includes('behavioral')) return "Patterns of conduct matter more than claims.";
    if (keys.includes('computer'))   return "Digital trails speak when people don‚Äôt.";
    if (keys.includes('timeline'))   return "Your clock is missing teeth.";
  }
  if (req.combo)        return "Parallel lanes should converge, not wander.";
  if (req.eitherTag)    return "Pick a lane that marks either time or authority.";
  if (req.channel==='narrative') return "Make the story inevitable, not decorative.";
  if (req.concise)      return "Trim the fat; meaning survives the cut.";
  if (req.plain)        return "Trade jargon for plain tools and wood.";
  if (req.authorityOrBehavioral) return "Procedure or behavior‚Äîchoose one and land it.";
  if (req.moral)        return "Name the duty before the blame.";
  return null;
}

/****************************************************************
 * Critical Combos ‚Äî Guaranteed but Hard Paths
 * If the player uses one of these tactic+tag mixes on the right juror,
 * we add a flat boost (pre-dice) so the juror is beatable even on bad rolls.
 ****************************************************************/
const CRITICAL = {
  GenZ:   [ {tactic:'cred', anyTag:['computer','behavioral']}, {tactic:'socratic', anyTag:['computer']}, {tactic:'forensic', anyTag:['computer']} ],
  Retiree:[ {tactic:'occam', anyTag:['behavioral','timeline']}, {tactic:'chrono', anyTag:['timeline']} ],
  Mom:    [ {tactic:'moral', anyTag:['behavioral']}, {tactic:'spiral', anyTag:['behavioral']} ],
  Tech:   [ {tactic:'forensic', anyTag:['forensic','computer']}, {tactic:'chrono', anyTag:['timeline','computer']} ],
  Blue:   [ {tactic:'occam', anyTag:['behavioral']}, {tactic:'cred', anyTag:['behavioral']} ],
  Prof:   [ {tactic:'socratic', anyTag:['forensic','behavioral']}, {tactic:'pattern', anyTag:['forensic','timeline']} ],
  RN:     [ {tactic:'forensic', anyTag:['forensic']} ],
  Vet:    [ {tactic:'chrono', anyTag:['timeline']}, {tactic:'occam', anyTag:['timeline','behavioral']} ],
  Artist: [ {tactic:'spiral', anyTag:['behavioral','timeline']} ],
  Exec:   [ {tactic:'chrono', anyTag:['timeline','behavioral']}, {tactic:'pattern', anyTag:['timeline','behavioral']} ],
  Clergy: [ {tactic:'moral', anyTag:['behavioral']} ],
};

function criticalHitFor(jurorKey, tacticKey, used){
  const rules = CRITICAL[jurorKey]||[];
  const tags = new Set();
  for(const ev of used){ (ev.tags||[]).forEach(t=>tags.add(t)); }
  for(const r of rules){
    if(r.tactic!==tacticKey) continue;
    if(r.anyTag && !r.anyTag.some(t=>tags.has(t))) continue;
    return true;
  }
  return false;
}

// REPLACE your existing generateResponse with this upgraded one:
function generateResponse(userText, selectedIds, juror, meter, tacticKey){
  const used=EVIDENCE.filter(e=>selectedIds.includes(e.id));
  let delta=0;
  // player text effect (already scaled to prosecution)
  if(userText) delta += messageEffect(userText, juror, tacticKey);
  // evidence effect (juror-weighted)
  for(const ev of used) delta += evidenceEffect(ev, juror)/3;
  // guaranteed-but-hard route
  if(criticalHitFor(juror.short, tacticKey, used)) delta += 6.5; // tuned for Hard
  // small natural variance (keeps it from feeling deterministic)
  delta += (Math.random()-0.5)*0.8;

  // juror voice reply (more helpful than "try again" but not easy)
  const mention = used.length ? " I hear you on " + used.map(e=>`‚Äú${e.title}‚Äù`).slice(0,2).join(" and ") + "." : "";
  const lead=voiceLead(juror.style, meter);
  const probe=voiceProbe(juror.style);
  const text=`${lead}${mention} ${probe}`.trim();
  return {text, delta};
}
  function rollD20(mode){ const d1=1+Math.floor(Math.random()*20), d2=1+Math.floor(Math.random()*20); return {d1,d2, roll: mode==='adv'?Math.max(d1,d2): mode==='dis'?Math.min(d1,d2): d1, mode}; }
  function applyJurorRules(juror, clas, used, text, turns, history){
    const key = juror.short;
    const R = JUROR_RULES[key]||{};
    const out={adv:false, dis:false, deltaBonus:0, deltaPenalty:0, blockFlip:false, msg:null};
    const tagCount = {...history};
    for(const ev of used){ (ev.tags||[]).forEach(t=>{ tagCount[t]=(tagCount[t]||0)+1; }); if(ev.side==='pros') tagCount.pros=(tagCount.pros||0)+1; if(ev.side==='def') tagCount.def=(tagCount.def||0)+1; }
    const len=(text||'').length;
    // Requirements
    if(R.req){
      if(R.req.tags){ for(const [t,need] of Object.entries(R.req.tags)){ if((tagCount[t]||0) < need){ out.blockFlip=true; out.msg=`Needs more ${t} evidence.`; } } }
      if(R.req.combo){ for(const [t,need] of R.req.combo){ if((tagCount[t]||0) < need){ out.blockFlip=true; out.msg=`Must include at least one ${t} item.`; } } }
      if(R.req.eitherTag){ const ok = R.req.eitherTag.some(t=> (tagCount[t]||0)>0 ); if(!ok){ out.blockFlip=true; out.msg=`Use a ${R.req.eitherTag.join(' or ')} item.`; } }
      if(R.req.channel==='narrative'){ const narrative = (clas.emotion + clas.culpability) > 0.6; if(!narrative){ out.blockFlip=true; out.msg=`Make a coherent narrative tying facts to guilt.`; } }
      if(R.req.concise && len>240){ out.deltaPenalty+=3; out.msg = out.msg||'Be concise for this juror.'; }
      if(R.req.plain && clas.logic>0.8 && clas.emotion<0.2){ out.deltaPenalty+=2; out.msg = out.msg||'Use plain, concrete points.'; }
      if(R.req.authorityOrBehavioral && !(clas.authority>0.3 || tagCount.behavioral>0)){ out.blockFlip=true; out.msg='Cite rules/procedure or concrete behavior.'; }
      if(R.req.moral && clas.emotion<0.25){ out.blockFlip=true; out.msg='Ground the case in duty, care, and harm.'; }
    }
    // Preferred styles grant advantage
    if(R.prefer==='logic' && clas.logic>clas.emotion) out.adv=true;
    if(R.prefer==='emotion' && clas.emotion>=Math.max(clas.logic,clas.authority)) out.adv=true;
    if(R.prefer==='authority' && clas.authority>0.25) out.adv=true;
    if(R.prefer==='narrative' && (clas.emotion+clas.culpability)>0.6) out.adv=true;
    if(R.prefer==='blunt' && len<200) out.adv=true;
    // Traps / penalties
    if(R.traps){
      if(R.traps.emotionHeavy && clas.emotion>0.6) out.dis=true;
      if(R.traps.clinicalHeavy && clas.logic>0.6 && clas.emotion<0.2) out.deltaPenalty+=2;
      if(R.traps.rambling && len>360) out.dis=true;
      if(R.traps.jargon && clas.logic>0.8 && clas.emotion<0.1) out.deltaPenalty+=3;
      if(R.traps.speculative && clas.doubt>0.3) out.dis=true;
      if(R.traps.punitiveOnly && clas.emotion<0.3 && clas.authority>0.3) out.deltaPenalty+=2;
      if(R.traps.authorityHeavy && clas.authority>0.5) out.deltaPenalty+=2;
      if(R.traps.doubtHeavy && clas.doubt>0.3) out.dis=true;
      if(R.traps.fallacy && clas.fallacy>0) out.deltaPenalty+=4;
      if(R.traps.defenseStrike && used.some(e=>e.side==='def')) out.dis=true;
    }
    // Tactic gating & extras
    const tactic = (document.getElementById('tactic')?.value)||'';
    if(R.tacticOneOf && R.tacticOneOf.length){
      if(!R.tacticOneOf.includes(tactic)){
        out.blockFlip = true;
        out.msg = out.msg || 'Use a tactic that fits this juror.';
      }
    }
    const tx = TACTICS[tactic]?.extra || {};
    if(tx.needsMultiTag){ const distinct = ['forensic','behavioral','computer','timeline'].filter(t=> (tagCount[t]||0)>0).length; if(distinct < 2){ out.deltaPenalty += 2; out.msg = out.msg || 'Show consistency across categories.'; } }
    if(tx.needsContradiction){ const usedTitles = used.map(u=> (u.title||'').toLowerCase()); const hinted = usedTitles.some(t => t.includes('unsupported') || t.includes('conflicting') || t.includes('false')); if(!hinted){ out.deltaPenalty += 2; out.msg = out.msg || 'Point out contradictions to build credibility theme.'; } }
    if(tx.antiClinical && clas.logic>0.6 && clas.emotion<0.25){ out.deltaPenalty += 2; }
    if(TACTICS[tactic]?.extra?.fallacyPenalty && clas.fallacy>0){ out.deltaPenalty += 2; }
    if(TACTICS[tactic]?.extra?.doubtPenalty && clas.doubt>0.35){ out.deltaPenalty += 2; }
    return out; 
  }

  function send(){
    if(state.gameOver) return;
    const text=(els.input.value||'').trim();
    if(!text && !state.selected.length) return;
    const juror=JURORS[state.idx];
    state.turns=(state.turns||0)+1;
    if(text){ state.chat.push({who:'user', text}); }
    const before = state.meter;
    const hist = state.history[state.idx];
    const usedNow = EVIDENCE.filter(e=>state.selected.includes(e.id));
    for(const ev of usedNow){ (ev.tags||[]).forEach(t=>{ hist[t]=(hist[t]||0)+1; }); if(ev.side==='pros') hist.pros=(hist.pros||0)+1; if(ev.side==='def') hist.def=(hist.def||0)+1; }
    const clasPreview = classify(text);
    const tacticKey = (document.getElementById('tactic')?.value)||'logic';
    let {text:reply, delta}=generateResponse(text, state.selected, juror, state.meter, tacticKey);
    // Diminishing returns for repeating the same tactic on the same juror
    state.lastTactic = state.lastTactic || Array(JURORS.length).fill(null);
    const last = state.lastTactic[state.idx];
    if(last && last === tacticKey){ delta *= 0.85; }
    state.lastTactic[state.idx] = tacticKey;

    const rule = applyJurorRules(juror, clasPreview, usedNow, text, state.turns, hist);
    if(rule.deltaPenalty) delta -= rule.deltaPenalty;
    if(rule.deltaBonus) delta += rule.deltaBonus;

    state.chat.push({who:'juror', text:reply});

    const clas=clasPreview;
    const used=EVIDENCE.filter(e=>state.selected.includes(e.id));
    const prosUsed = used.filter(e=>e.side==='pros').length;
    const defUsed = used.some(e=>e.side==='def');
    const aligns = (tacticKey==='logic' && juror.values.logic>0.8) || (tacticKey==='emotion' && juror.values.emotion>0.8) || (tacticKey==='authority' && juror.values.authority>0.8) || (tacticKey==='narrative' && juror.values.emotion>0.6 && juror.values.logic>0.4);
    const adv = ((prosUsed>=2 && clas.doubt<0.3) || aligns || rule.adv);
    const dis = (defUsed || clas.doubt>0.5 || rule.dis);
    const mode = adv && !dis ? 'adv' : dis && !adv ? 'dis' : 'normal';
    const r = rollD20(mode);
    if(r.roll===1){ state.strikes=Math.min(DIFFICULTY.maxStrikes,(state.strikes||0)+1); state.chat.push({who:'juror', text:`üí• Critical miss (nat 1). Strike added.`}); }
    if(r.roll===20){ delta *= 1.25; state.chat.push({who:'juror', text:`‚ú® Critical success (nat 20). Argument hits harder.`}); }
    const diceMult = (r.roll===1)?0.2 : (r.roll===20)?1.9 : (10 + (r.roll-10)*1.1)/20; delta *= diceMult;
    state.chat.push({who:'juror', text:`üé≤ d20: ${r.roll}${r.mode!=='normal'?` (${r.mode})`:''} ‚Üí multiplier ${diceMult.toFixed(2)}.`});

    if(clas.doubt>0.4 || used.some(e=>e.side==='def')){ state.strikes=Math.min(DIFFICULTY.maxStrikes,(state.strikes||0)+1); state.meter = Math.max(0, state.meter - DIFFICULTY.strikePenalty); const extraThresh = Math.floor(state.strikes/2)*DIFFICULTY.strikeThresholdBoostPer2; state.chat.push({who:'juror', text:`‚ö†Ô∏è Strike ${state.strikes}/${DIFFICULTY.maxStrikes}: defense‚Äëleaning/doubt. ‚àí${DIFFICULTY.strikePenalty} meter. Threshold +${extraThresh} total.`}); }

    state.meter = Math.max(0, Math.min(100, state.meter + delta - DIFFICULTY.meterDecay));
    const change = Math.round(state.meter - before); const sign = change>0?"üìà":"üìâ"; if(change!==0){ state.chat.push({who:'juror', text:`${sign} Meter ${change>0?'+':''}${change}.`}); }
state.lastChange[state.idx] = change;
if (change <= 0) { state.fails[state.idx] = (state.fails[state.idx] || 0) + 1; }
else { state.fails[state.idx] = 0; }

// Light-touch hints after 2 and 4 unproductive turns
if (state.fails[state.idx] === 2 || state.fails[state.idx] === 4) {
  const key = JURORS[state.idx].short;
  state.chat.push({ who:'juror', text: getHint(key, state.fails[state.idx] === 4 ? 1 : 0) });
}

state.selected = [];
els.input.value = '';

    const effectiveThreshold = juror.threshold + DIFFICULTY.thresholdBoost + Math.floor((state.strikes||0)/2)*DIFFICULTY.strikeThresholdBoostPer2;
    if(state.strikes>=DIFFICULTY.maxStrikes){ return gameOver('Too many strikes (arguments aided the defense).'); }
// Low-patience flavor ping (last 3 steps)
{
  const left = Math.max(0, DIFFICULTY.turnLimit - state.turns);
  if (left <= 3) {
    state.chat.push({
      who: 'juror',
      text: `‚è≥ The room's patience is thinning ‚Äî ${left}/${DIFFICULTY.turnLimit} left.`
    });
  }
}
    if(state.meter>=effectiveThreshold){
    if (rule.blockFlip) {
  const hint = vagueReqHint((JUROR_RULES[juror.short]||{}).req) || getHint(juror.short, 1);
  state.chat.push({ who:'juror', text: `Not there yet ‚Äî ${hint}` });
}

      else { state.persuaded[state.idx]=true; state.chat.push({who:'juror', text:`Alright, I'm convinced. Move on.`}); const next=state.persuaded.indexOf(false); if(next===-1){ overlay('Verdict ‚Äî GUILTY','All jurors convinced.'); state.gameOver=true; saveState(); renderAll(); return; } else { state.idx=next; state.meter=0; state.turns=0; state.chat=[{who:'juror', text:openingLine(JURORS[state.idx])}]; } }
    }
    saveState(); renderAll();
  }


  /*************************************************
   * End States, UI Wiring & Boot
   *************************************************/
  function gameOver(reason){ state.gameOver=true; state.reason=reason; overlay('Game Over', reason); renderAll(); }
  function overlay(title, reason){ const o=document.getElementById('overlay'); if(!o) return; const t=document.getElementById('gameover-title'); const r=document.getElementById('gameover-reason'); if(t) t.textContent=title; if(r) r.textContent=reason; o.style.display='flex'; }
  function hideOverlay(){ const o=document.getElementById('overlay'); if(o) o.style.display='none'; const i=document.getElementById('intro'); if(i) i.style.display='none'; }

  function renderAll(){ renderJuror(); renderProgress(); renderChat(); renderSelected(); renderEvidence(); renderTimeline(); renderFacts(); }

  function reset(){ state = DEFAULT_STATE(); activeFilters.clear(); document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); if(els.evSearch) els.evSearch.value=''; if(els.input) els.input.value=''; state.selected=[]; renderAll(); const intro=document.getElementById('intro'); if(intro) intro.style.display='flex'; const th=document.getElementById('theories'); if(th) th.style.display='none'; }

  function exportSave(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='juror_save.json'; a.click(); URL.revokeObjectURL(url); }
  function importSave(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{ try{ const s=JSON.parse(rd.result); state=Object.assign(DEFAULT_STATE(), s); renderAll(); }catch(e){ alert('Invalid save file'); } }; rd.readAsText(f); }; inp.click(); }

  // Tabs and chips
  document.querySelectorAll('.tabs button').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.side .pane').forEach(p=>p.classList.remove('active')); btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active'); }); });
  document.querySelectorAll('.chip').forEach(ch=>{ ch.addEventListener('click', ()=>{ const key=ch.dataset.filter; if(activeFilters.has(key)) activeFilters.delete(key); else activeFilters.add(key); ch.classList.toggle('active'); renderEvidence(); }); });

  // Buttons
  document.getElementById('btn-retry').addEventListener('click', ()=>{ state = DEFAULT_STATE(); hideOverlay(); renderAll(); });
  document.getElementById('btn-quit').addEventListener('click', reset);
  document.getElementById('btn-clear-sel').addEventListener('click', ()=>{ state.selected=[]; renderSelected(); });
  document.getElementById('btn-send').addEventListener('click', send);
  document.getElementById('btn-reset').addEventListener('click', reset);
  document.getElementById('btn-export').addEventListener('click', exportSave);
  document.getElementById('btn-import').addEventListener('click', importSave);
  document.getElementById('ev-search').addEventListener('input', ()=>renderEvidence());
  document.getElementById('ev-clear').addEventListener('click', ()=>{ document.getElementById('ev-search').value=''; activeFilters.clear(); document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); renderEvidence(); });

// Intro ‚Üí Case ‚Üí Theories flow
document.getElementById('btn-start').addEventListener('click', ()=>{
  const intro = document.getElementById('intro');
  const cs    = document.getElementById('case');
  if (intro) intro.style.display = 'none';
  if (cs)    cs.style.display    = 'flex';
});

document.getElementById('btn-case-continue').addEventListener('click', ()=>{
  const cs = document.getElementById('case');
  const th = document.getElementById('theories');
  if (cs) cs.style.display = 'none';
  if (th) th.style.display = 'flex';
});

document.getElementById('btn-theories-continue').addEventListener('click', ()=>{
  const th = document.getElementById('theories');
  if (th) th.style.display = 'none';
  // game starts when overlays are gone
});

  // Boot
  state = loadState();
  renderAll();
  // Always show intro at start
  document.getElementById('intro').style.display='flex';
  </script>
<script>
(function(){
  const TITLE_TEXT = "Dungeons and Deliberations";
  const SUB_TEXT   = "Can you sway your fellow jurors?";
  const SPEED = 50;           // ms per character
  const PAUSE = 600;          // delay between title and subtitle
  const ANIMATION_DELAY = 800; // delay before showing video

  const titleEl = document.getElementById("intro-title");
  const subEl   = document.getElementById("intro-sub");
  const caret   = document.getElementById("intro-caret");
  const overlay = document.getElementById("typing-intro");
  const animationEl = document.getElementById("transition-animation");
  const video = document.getElementById("runner-video");

  function typeText(el, text) {
    return new Promise(resolve=>{
      let i=0;
      const tick = () => {
        el.textContent = text.slice(0, i++);
        if(i <= text.length) setTimeout(tick, SPEED);
        else resolve();
      };
      tick();
    });
  }

  async function run() {
    await typeText(titleEl, TITLE_TEXT);
    await new Promise(r=>setTimeout(r, PAUSE));
    await typeText(subEl, SUB_TEXT);
    caret.style.display="none";
    
    // Show video animation after typing is done
    setTimeout(() => {
      animationEl.classList.add("show-animation");
      video.play();
      
      // Auto-start the game when video ends
      video.addEventListener('ended', () => {
        setTimeout(() => {
          overlay.classList.add("fade-out");
          
          // Show the intro modal after fade completes
          setTimeout(() => {
            const introModal = document.getElementById('intro');
            if (introModal) {
              introModal.style.display = 'flex';
            }
          }, 1000);
        }, 500); // Small delay after video ends
      });
      
    }, ANIMATION_DELAY);
  }

  // Start typing on DOM ready
  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", run, {once:true});
  } else {
    run();
  }
})();
</script>
<script>
(function(){
  const TITLE_TEXT = "Dungeons and Deliberations";
  const SUB_TEXT   = "Can you sway your fellow jurors?";
  const SPEED = 50;           // ms per character
  const PAUSE = 600;          // delay between title and subtitle
  const HIDE_DELAY = 1000;    // after typing done, before fade

  const titleEl = document.getElementById("intro-title");
  const subEl   = document.getElementById("intro-sub");
  const caret   = document.getElementById("intro-caret");
  const overlay = document.getElementById("typing-intro");

  function typeText(el, text) {
    return new Promise(resolve=>{
      let i=0;
      const tick = () => {
        el.textContent = text.slice(0, i++);
        if(i <= text.length) setTimeout(tick, SPEED);
        else resolve();
      };
      tick();
    });
  }

await typeText(subEl, SUB_TEXT);

// show & start the video immediately after subtitle finishes
const video = document.getElementById('runnerAnimation');
if (video) {
  video.currentTime = 0;
  video.style.opacity = '1';

  try { await video.play(); } catch (_) {}

  // wait for the video to finish *before* moving on
  if (!video.ended) {
    await new Promise(resolve => video.addEventListener('ended', resolve, { once: true }));
  }
}

// now hide the caret and advance
caret.style.display = "none";
overlay.classList.add("fade-out"); // no delay ‚Äî we already waited for the video

  }

  // Start typing on DOM ready
  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", run, {once:true});
  } else {
    run();
  }
})();
</script>
<script>
  // ... all your existing JS code above ...

  // runneranimation skip lock
  const video = document.getElementById('runnerAnimation');
  if (video) {
    video.addEventListener('play', () => {
      window.addEventListener('keydown', blockKeys, true);
    });
    video.addEventListener('ended', () => {
      window.removeEventListener('keydown', blockKeys, true);
    });
  }

  function blockKeys(e) {
    const blocked = ['Enter',' ','Spacebar','Escape','ArrowRight'];
    if (blocked.includes(e.key)) e.preventDefault();
  }

</script>

</body>
</html>
